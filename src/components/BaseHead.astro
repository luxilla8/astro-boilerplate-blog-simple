---
import { getSiteConfig } from '../config/site';
const siteConfig = await getSiteConfig();

export interface Props {
  title: string;
  description: string;
  image?: string;
  imageAlt?: string;
  canonicalUrl?: string;
  type?: 'website' | 'article';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  tags?: string[];
  noindex?: boolean;
}

const {
  title,
  description,
  image = siteConfig.ogImage,
  imageAlt = title,
  canonicalUrl,
  type = 'website',
  publishedTime,
  modifiedTime,
  author = siteConfig.author.name,
  tags = [],
  noindex = false,
} = Astro.props;

const fullTitle = title === siteConfig.name
  ? title
  : siteConfig.seo.titleTemplate.replace('%s', title);
const canonical = canonicalUrl || Astro.url.href;
const siteUrl = Astro.site?.href || siteConfig.url;
const imageUrl = image.startsWith('http') ? image : new URL(image, siteUrl).href;
const logoUrl = new URL(siteConfig.logo, siteUrl).href;

// Build breadcrumb from URL path
const pathSegments = Astro.url.pathname.split('/').filter(Boolean);
const breadcrumbItems = [
  { name: 'Home', url: siteUrl },
  ...pathSegments.map((segment, index) => ({
    name: segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, ' '),
    url: new URL(pathSegments.slice(0, index + 1).join('/'), siteUrl).href,
  })),
];

// Schema.org structured data
const schemas: object[] = [];

// WebSite schema (always include on homepage)
if (Astro.url.pathname === '/') {
  schemas.push({
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    '@id': `${siteUrl}#website`,
    name: siteConfig.name,
    description: siteConfig.description,
    url: siteUrl,
    publisher: { '@id': `${siteUrl}#organization` },
  });
}

// Organization schema (always include)
schemas.push({
  '@context': 'https://schema.org',
  '@type': 'Organization',
  '@id': `${siteUrl}#organization`,
  name: siteConfig.organization.name,
  url: siteUrl,
  logo: {
    '@type': 'ImageObject',
    '@id': `${siteUrl}#logo`,
    url: logoUrl,
    contentUrl: logoUrl,
    caption: siteConfig.organization.name,
  },
  image: { '@id': `${siteUrl}#logo` },
  sameAs: siteConfig.organization.sameAs,
});

// BreadcrumbList schema (for non-homepage pages)
if (breadcrumbItems.length > 1) {
  schemas.push({
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    '@id': `${canonical}#breadcrumb`,
    itemListElement: breadcrumbItems.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.name,
      item: item.url,
    })),
  });
}

// Article/BlogPosting schema
if (type === 'article') {
  schemas.push({
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    '@id': `${canonical}#article`,
    isPartOf: { '@id': `${siteUrl}#website` },
    headline: title,
    description: description,
    image: {
      '@type': 'ImageObject',
      url: imageUrl,
    },
    datePublished: publishedTime?.toISOString(),
    dateModified: modifiedTime?.toISOString() || publishedTime?.toISOString(),
    author: {
      '@type': 'Person',
      name: author,
      url: siteConfig.author.url,
    },
    publisher: { '@id': `${siteUrl}#organization` },
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': canonical,
    },
    keywords: tags.join(', '),
    articleSection: 'Blog',
    inLanguage: siteConfig.seo.openGraph.locale.split('_')[0],
  });
} else if (type === 'website' && Astro.url.pathname !== '/') {
  // WebPage schema for non-article pages
  schemas.push({
    '@context': 'https://schema.org',
    '@type': 'WebPage',
    '@id': canonical,
    url: canonical,
    name: title,
    description: description,
    isPartOf: { '@id': `${siteUrl}#website` },
    breadcrumb: { '@id': `${canonical}#breadcrumb` },
    inLanguage: siteConfig.seo.openGraph.locale.split('_')[0],
  });
}

// Combine all schemas into a graph
const jsonLd = {
  '@context': 'https://schema.org',
  '@graph': schemas,
};
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="generator" content={Astro.generator} />

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href={siteConfig.logo} />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />

<!-- Canonical URL -->
<link rel="canonical" href={canonical} />

<!-- Robots -->
{noindex ? (
  <meta name="robots" content="noindex, nofollow" />
) : (
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
)}

<!-- Primary Meta Tags -->
<title>{fullTitle}</title>
<meta name="title" content={fullTitle} />
<meta name="description" content={description} />
{author && <meta name="author" content={author} />}
{tags.length > 0 && <meta name="keywords" content={tags.join(', ')} />}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type === 'article' ? 'article' : 'website'} />
<meta property="og:url" content={canonical} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={imageUrl} />
<meta property="og:image:alt" content={imageAlt} />
<meta property="og:site_name" content={siteConfig.name} />
<meta property="og:locale" content={siteConfig.seo.openGraph.locale} />

{type === 'article' && publishedTime && (
  <meta property="article:published_time" content={publishedTime.toISOString()} />
)}
{type === 'article' && modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime.toISOString()} />
)}
{type === 'article' && author && (
  <meta property="article:author" content={author} />
)}
{type === 'article' && tags.map((tag) => (
  <meta property="article:tag" content={tag} />
))}

<!-- Twitter -->
<meta name="twitter:card" content={siteConfig.seo.twitter.cardType} />
<meta name="twitter:url" content={canonical} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={imageUrl} />
<meta name="twitter:image:alt" content={imageAlt} />
{siteConfig.social.twitter && (
  <meta name="twitter:site" content={siteConfig.social.twitter.startsWith('@') ? siteConfig.social.twitter : `@${siteConfig.social.twitter}`} />
)}

<!-- JSON-LD Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

<!-- Sitemap -->
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title={siteConfig.name} href="/rss.xml" />
