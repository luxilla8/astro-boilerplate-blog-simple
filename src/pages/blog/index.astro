---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import CategoryBadge from '../../components/CategoryBadge.astro';
import Icon from '../../components/Icon.astro';

// Get all published blog posts, sorted by date
const allPosts = await getCollection('blog');
const publishedPosts = allPosts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Featured post (latest) and rest
const [featuredPost, ...otherPosts] = publishedPosts;

// Get categories for display
const categories = await getCollection('categories');
const categoryMap = new Map(categories.map((cat) => [cat.id, cat.data]));

// Count posts per category
const categoryCounts = new Map<string, number>();
publishedPosts.forEach((post) => {
  const count = categoryCounts.get(post.data.category) || 0;
  categoryCounts.set(post.data.category, count + 1);
});
---

<BaseLayout
  title="Blog"
  description="Read the latest articles on web development, technology, and more."
>
  <!-- Header -->
  <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white py-20 md:py-28">
    <div class="max-w-6xl mx-auto px-6 md:px-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-5">
        Blog
      </h1>
      <p class="text-xl text-gray-300 max-w-2xl leading-relaxed">
        Thoughts, tutorials, and insights on web development and technology.
      </p>
    </div>
  </div>

  <!-- Search & Category Filter -->
  <div class="border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 sticky top-16 z-40">
    <div class="max-w-6xl mx-auto px-6 md:px-8">
      <div class="flex items-center gap-4 py-4 overflow-x-auto">
        <div class="relative flex-shrink-0 w-56">
          <Icon name="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" />
          <input
            type="search"
            id="blog-search"
            placeholder="Search posts..."
            class="w-full pl-9 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>
        {categories.length > 0 && (
          <>
            <div class="w-px h-6 bg-gray-200 dark:bg-gray-700 flex-shrink-0"></div>
            <nav class="flex gap-2 flex-shrink-0" aria-label="Filter by category">
              <a
                href="/blog"
                class="flex-shrink-0 px-4 py-2 text-sm font-medium bg-primary-600 text-white rounded-full"
              >
                All
                <span class="ml-1.5 px-1.5 py-0.5 bg-white/20 rounded-full text-xs">
                  {publishedPosts.length}
                </span>
              </a>
              {categories.map((category) => (
                <a
                  href={`/blog/category/${category.id}`}
                  class="flex-shrink-0 px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
                >
                  {category.data.name}
                  <span class="ml-1.5 text-gray-400 text-xs">
                    {categoryCounts.get(category.id) || 0}
                  </span>
                </a>
              ))}
            </nav>
          </>
        )}
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-6 md:px-8 py-16 md:py-20">
    {publishedPosts.length === 0 ? (
      <div class="text-center py-20 bg-gray-50 dark:bg-gray-800 rounded-2xl">
        <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
          <Icon name="document" class="w-8 h-8 text-gray-400" />
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">No posts yet</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Get started by creating your first post.</p>
        <a
          href="/keystatic"
          class="inline-flex items-center px-5 py-2.5 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors"
        >
          Open Keystatic Admin
        </a>
      </div>
    ) : (
      <>
        <!-- Featured Post -->
        {featuredPost && (
          <section class="mb-20" data-search-item data-search-title={featuredPost.data.title} data-search-description={featuredPost.data.description}>
            <div class="flex items-center gap-2 mb-8">
              <span class="inline-flex items-center px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 text-sm font-medium rounded-full">
                Featured
              </span>
            </div>

            <a href={`/blog/${featuredPost.id}`} class="group block">
              <article class="grid md:grid-cols-2 gap-10 items-center">
                {featuredPost.data.heroImage ? (
                  <div class="aspect-video rounded-2xl overflow-hidden bg-gray-200 dark:bg-gray-700 shadow-lg">
                    <img
                      src={featuredPost.data.heroImage}
                      alt={featuredPost.data.heroImageAlt || featuredPost.data.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="eager"
                      fetchpriority="high"
                      decoding="async"
                    />
                  </div>
                ) : (
                  <div class="aspect-video rounded-2xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center shadow-lg">
                    <span class="text-white/30 text-6xl font-bold">
                      {featuredPost.data.title.charAt(0)}
                    </span>
                  </div>
                )}

                <div>
                  <div class="flex items-center gap-3 mb-4">
                    {categoryMap.get(featuredPost.data.category) && (
                      <CategoryBadge
                        category={featuredPost.data.category}
                        name={categoryMap.get(featuredPost.data.category)!.name}
                        color={categoryMap.get(featuredPost.data.category)!.color}
                      />
                    )}
                    <time datetime={featuredPost.data.pubDate.toISOString()} class="text-sm text-gray-500">
                      <FormattedDate date={featuredPost.data.pubDate} />
                    </time>
                  </div>

                  <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
                    {featuredPost.data.title}
                  </h2>

                  <p class="text-gray-600 dark:text-gray-400 text-lg mb-6 line-clamp-3">
                    {featuredPost.data.description}
                  </p>

                  <span class="inline-flex items-center text-primary-600 font-medium">
                    Read article
                    <Icon name="arrow-right" class="ml-2 w-4 h-4 transition-transform group-hover:translate-x-1" />
                  </span>
                </div>
              </article>
            </a>
          </section>
        )}

        <!-- All Posts -->
        {otherPosts.length > 0 && (
          <section>
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-8">
              {featuredPost ? 'More Articles' : 'All Articles'}
            </h2>
            <div class="grid gap-8 md:gap-10 md:grid-cols-2 lg:grid-cols-3" id="blog-grid">
              {otherPosts.map((post) => (
                <div data-search-item data-search-title={post.data.title} data-search-description={post.data.description}>
                  <BlogCard
                    post={post}
                    categoryData={categoryMap.get(post.data.category)}
                  />
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- No results message (hidden by default) -->
        <div id="no-results" class="hidden text-center py-12">
          <p class="text-gray-500 text-lg">No posts match your search.</p>
        </div>
      </>
    )}
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('blog-search') as HTMLInputElement;
  const items = document.querySelectorAll('[data-search-item]');
  const noResults = document.getElementById('no-results');

  searchInput?.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase().trim();
    let visible = 0;

    items.forEach((item) => {
      const title = (item as HTMLElement).dataset.searchTitle?.toLowerCase() || '';
      const desc = (item as HTMLElement).dataset.searchDescription?.toLowerCase() || '';
      const match = !query || title.includes(query) || desc.includes(query);
      (item as HTMLElement).style.display = match ? '' : 'none';
      if (match) visible++;
    });

    if (noResults) {
      noResults.classList.toggle('hidden', visible > 0);
    }
  });
</script>
