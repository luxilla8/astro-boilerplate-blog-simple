---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogCard from '../../../components/BlogCard.astro';

export async function getStaticPaths() {
  const categories = await getCollection('categories');

  return categories.map((category) => ({
    params: { category: category.id },
    props: { category },
  }));
}

const { category } = Astro.props;

// Get all posts in this category
const allPosts = await getCollection('blog');
const categoryPosts = allPosts
  .filter((post) => !post.data.draft && post.data.category === category.id)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get all categories for navigation
const categories = await getCollection('categories');
const categoryMap = new Map(categories.map((cat) => [cat.id, cat.data]));

// Count posts per category
const categoryCounts = new Map<string, number>();
allPosts
  .filter((post) => !post.data.draft)
  .forEach((post) => {
    const count = categoryCounts.get(post.data.category) || 0;
    categoryCounts.set(post.data.category, count + 1);
  });

const totalPosts = allPosts.filter((post) => !post.data.draft).length;
---

<BaseLayout
  title={`${category.data.name} Posts`}
  description={category.data.description || `Browse all posts in the ${category.data.name} category.`}
>
  <!-- Header -->
  <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white py-20 md:py-28">
    <div class="max-w-6xl mx-auto px-6 md:px-8">
      <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm text-gray-400">
          <li><a href="/blog" class="hover:text-white transition-colors">Blog</a></li>
          <li>/</li>
          <li class="text-gray-300">Category</li>
        </ol>
      </nav>
      <h1 class="text-4xl md:text-5xl font-bold mb-5">
        {category.data.name}
      </h1>
      {category.data.description && (
        <p class="text-xl text-gray-300 max-w-2xl leading-relaxed">
          {category.data.description}
        </p>
      )}
    </div>
  </div>

  <!-- Category Filter -->
  <div class="border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 sticky top-16 z-40">
    <div class="max-w-6xl mx-auto px-6 md:px-8">
      <nav class="flex gap-2 py-4 overflow-x-auto" aria-label="Filter by category">
        <a
          href="/blog"
          class="flex-shrink-0 px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
        >
          All
          <span class="ml-1.5 text-gray-400 dark:text-gray-500 text-xs">
            {totalPosts}
          </span>
        </a>
        {categories.map((cat) => (
          <a
            href={`/blog/category/${cat.id}`}
            class:list={[
              'flex-shrink-0 px-4 py-2 text-sm font-medium rounded-full transition-colors',
              cat.id === category.id
                ? 'bg-primary-600 text-white'
                : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-800',
            ]}
          >
            {cat.data.name}
            <span class:list={[
              'ml-1.5 text-xs',
              cat.id === category.id
                ? 'px-1.5 py-0.5 bg-white/20 rounded-full'
                : 'text-gray-400 dark:text-gray-500',
            ]}>
              {categoryCounts.get(cat.id) || 0}
            </span>
          </a>
        ))}
      </nav>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-6 md:px-8 py-16 md:py-20">
    <!-- Posts Grid -->
    {categoryPosts.length > 0 ? (
      <div class="grid gap-8 md:gap-10 md:grid-cols-2 lg:grid-cols-3">
        {categoryPosts.map((post) => (
          <BlogCard
            post={post}
            categoryData={categoryMap.get(post.data.category)}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-20 bg-gray-50 dark:bg-gray-800 rounded-2xl">
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          No posts in this category yet.
        </p>
        <a
          href="/blog"
          class="inline-flex items-center text-primary-600 font-medium hover:underline"
        >
          View all posts
        </a>
      </div>
    )}
  </div>
</BaseLayout>
