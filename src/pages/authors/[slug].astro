---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import Icon from '../../components/Icon.astro';

export async function getStaticPaths() {
  const authors = await getCollection('authors');

  return authors.map((author) => ({
    params: { slug: author.id },
    props: { author },
  }));
}

const { author } = Astro.props;

// Get all published posts by this author
const allPosts = await getCollection('blog');
const authors = await getCollection('authors');
const firstAuthorId = authors[0]?.id;

const authorPosts = allPosts
  .filter((post) => {
    if (post.data.draft) return false;
    const postAuthor = post.data.author || firstAuthorId;
    return postAuthor === author.id;
  })
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get categories for BlogCard
const categories = await getCollection('categories');
const categoryMap = new Map(categories.map((cat) => [cat.id, cat.data]));

const socialLinks = [
  { name: 'twitter', url: author.data.twitter, label: 'Twitter' },
  { name: 'github', url: author.data.github, label: 'GitHub' },
  { name: 'linkedin', url: author.data.linkedin, label: 'LinkedIn' },
].filter((link) => link.url);
---

<BaseLayout
  title={author.data.name}
  description={author.data.bio || `Posts by ${author.data.name}.`}
>
  <!-- Author Hero -->
  <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white py-20 md:py-28">
    <div class="max-w-6xl mx-auto px-6 md:px-8">
      <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm text-gray-400">
          <li><a href="/blog" class="hover:text-white transition-colors">Blog</a></li>
          <li>/</li>
          <li><a href="/authors" class="hover:text-white transition-colors">Authors</a></li>
          <li>/</li>
          <li class="text-gray-300">{author.data.name}</li>
        </ol>
      </nav>

      <div class="flex flex-col sm:flex-row items-start gap-6">
        {author.data.avatar ? (
          <img
            src={author.data.avatar}
            alt={author.data.name}
            class="w-24 h-24 rounded-full object-cover flex-shrink-0 ring-4 ring-white/10"
            loading="eager"
            fetchpriority="high"
            decoding="async"
          />
        ) : (
          <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center text-white font-bold text-3xl flex-shrink-0 ring-4 ring-white/10">
            {author.data.name.charAt(0)}
          </div>
        )}

        <div>
          <h1 class="text-4xl md:text-5xl font-bold mb-3">
            {author.data.name}
          </h1>

          {author.data.bio && (
            <p class="text-xl text-gray-300 max-w-2xl leading-relaxed mb-4">
              {author.data.bio}
            </p>
          )}

          <div class="flex items-center gap-4">
            <span class="text-sm text-gray-400">
              {authorPosts.length} {authorPosts.length === 1 ? 'post' : 'posts'}
            </span>

            {socialLinks.length > 0 && (
              <>
                <span class="w-px h-4 bg-gray-600"></span>
                <div class="flex items-center gap-3">
                  {socialLinks.map((link) => (
                    <a
                      href={link.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 hover:text-white transition-colors"
                      aria-label={link.label}
                    >
                      <Icon name={link.name} class="w-5 h-5" />
                    </a>
                  ))}
                </div>
              </>
            )}

            {author.data.url && (
              <>
                <span class="w-px h-4 bg-gray-600"></span>
                <a
                  href={author.data.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm text-gray-400 hover:text-white transition-colors"
                >
                  Website
                </a>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-6 md:px-8 py-16 md:py-20">
    {authorPosts.length > 0 ? (
      <>
        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-8">
          Posts by {author.data.name}
        </h2>
        <div class="grid gap-8 md:gap-10 md:grid-cols-2 lg:grid-cols-3">
          {authorPosts.map((post) => (
            <BlogCard
              post={post}
              categoryData={categoryMap.get(post.data.category)}
            />
          ))}
        </div>
      </>
    ) : (
      <div class="text-center py-20 bg-gray-50 dark:bg-gray-800 rounded-2xl">
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          No posts by this author yet.
        </p>
        <a
          href="/blog"
          class="inline-flex items-center text-primary-600 font-medium hover:underline"
        >
          View all posts
        </a>
      </div>
    )}
  </div>
</BaseLayout>
